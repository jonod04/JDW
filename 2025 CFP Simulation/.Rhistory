c(statcast2024$batter, statcast2024$pitcher,
statcast2024$on_1b, statcast2024$on_2b, statcast2024$on_3b,
statcast2024$fielder_2, statcast2024$fielder_3,
statcast2024$fielder_3, statcast2024$fielder_4,
statcast2024$fielder_5, statcast2024$fielder_6,
statcast2024$fielder_7, statcast2024$fielder_8,
statcast2024$fielder_9))
chadwick_players <- baseballr::chadwick_player_lu()
save(chadwick_players, file = "chadwick_players.RData")
player2024_lookup <-
chadwick_players |>
dplyr::filter(!is.na(key_mlbam) & key_mlbam %in% player2024_id) |>
dplyr::mutate(
FullName = paste(name_first, name_last),
Name = stringi::stri_trans_general(FullName, "Latin-ASCII"))
save(player2024_lookup, file = "player2024_lookup.RData")
View(chadwick_players)
View(player2024_lookup)
baseballr::mlb_batting_orders(game_pk = 745444)
get_lineup <- function(game_pk){
lineup <- baseballr::mlb_batting_orders(game_pk = game_pk)
lineup <-
lineup |>
dplyr::mutate(game_pk = game_pk) |>
dplyr::rename(key_mlbam = id, position = abbreviation) |>
dplyr::select(game_pk, key_mlbam, position)
return(lineup)
}
all_lineups <- list()
unik_game_pk <- unique(statcast2024$game_pk)
for(i in 1:length(unik_game_pk)){
all_lineups[[i]] <- get_lineup(game_pk = unik_game_pk[i])
}
poss_get_lineup <- purrr::possibly(.f = get_lineup, otherwise = NULL)
unik_game_pk <- unique(statcast2024$game_pk)
block_starts <- seq(1, length(unik_game_pk), by = 500)
block_ends <- c(block_starts[-1], length(unik_game_pk))
all_lineups <- list()
for(b in 1:5){
tmp <-
purrr::map(.x = unik_game_pk[block_starts[b]:block_ends[b]],
.f = poss_get_lineup,
.progress = TRUE)
all_lineups <- c(all_lineups, tmp)
}
install.packages("lme4")
library(lme4)
multilevel_fit <-
lmer(formula = epa ~ 1 + (1|passer_player_id),
data = pass2024)
pbp2024 <- nflfastR::load_pbp(season = 2024)
library(nflfastR)
pbp2024 <- nflfastR::load_pbp(season = 2024)
roster2024 <-
nflfastR::fast_scraper_roster(seasons = 2024)
pbp2024 |>
dplyr::slice_max(epa) |>
dplyr::select(ep, desc)
pbp2024 |>
dplyr::filter(posteam=="DAL" & play_type == "pass") |>
dplyr::slice_max(epa) |>
dplyr::select(ep, desc)
pbp2024 |>
dplyr::group_by(posteam) |>
dplyr::summarize(epa = mean(epa, na.rm = TRUE)) |>
dplyr::arrange(desc(epa)) |>
dplyr::slice(c(1:5, (dplyr::n()-4):(dplyr::n())))
table(pbp2024[,c("play_type", "season_type")])
pass2024 <-
pbp2024 |>
dplyr::filter(play_type == "pass" & season_type == "REG") |>
dplyr::filter(!grepl("TWO-POINT CONVERSION ATTEMPT", desc) &
!grepl("sacked", desc)) |>
dplyr::select(epa, passer_player_id, desc)
pass2024 |> dplyr::slice_head(n = 2)
mean(pass2024$epa)
rodgers_id <-
roster2024 |>
dplyr::filter(full_name == "Aaron Rodgers") |>
dplyr::pull(gsis_id)
pass2024 <-
pass2024 |>
dplyr::mutate(
passer_player_id = factor(passer_player_id),
passer_player_id = relevel(passer_player_id, ref = rodgers_id))
ols_fit <-
lm(formula = epa ~ 1 + passer_player_id,
data = pass2024)
ols_betas <- coefficients(ols_fit)
ols_betas[1:5]
mean( pass2024$epa[pass2024$passer_player_id == rodgers_id])
mean(pass2024$epa[pass2024$passer_player_id == "00-0033077"])
ols_betas["passer_player_id00-0033077"] + ols_betas["(Intercept)"]
names(ols_betas)[1] <- paste0("passser_player_id", rodgers_id)
names(ols_betas) <-
stringr::str_remove(string = names(ols_betas), pattern = "passer_player_id")
alphas <-
data.frame(gsis_id = names(ols_betas), ols = ols_betas) |>
dplyr::mutate(ols = ifelse(gsis_id == rodgers_id, ols, ols + dplyr::first(ols))) |>
dplyr::inner_join(y = roster2024 |> dplyr::select(gsis_id, full_name), by = "gsis_id")
alphas |>
dplyr::arrange(dplyr::desc(ols)) |>
dplyr::slice(c(1:5, (dplyr::n()-4):dplyr::n())) |>
dplyr::select(full_name, ols)
n_passes <-
pass2024 |>
dplyr::group_by(passer_player_id) |>
dplyr::summarise(n = dplyr::n()) |>
dplyr::rename(gsis_id = passer_player_id)
alphas <-
alphas |>
dplyr::inner_join(y = n_passes, by = "gsis_id")
alphas |>
dplyr::arrange(dplyr::desc(ols)) |>
dplyr::slice(c(1:5, (dplyr::n()-4):dplyr::n()))
pass2024 |>
dplyr::filter(passer_player_id == "00-0035190") |>
dplyr::select(desc, epa)
oi_colors <-
palette.colors(palette = "Okabe-Ito")
par(mar = c(3,3,2,1), mgp = c(1.8, 0.5, 0))
plot(alphas$n, alphas$ols,
xlab = "Number of passes",
ylab = "Avg. EPA per pass",
main = "EPA per pass",
pch = 16, cex = 0.5, col = oi_colors[1])
abline(h = mean(pass2024$epa), col = oi_colors[3])
library(lme4)
multilevel_fit <-
lmer(formula = epa ~ 1 + (1|passer_player_id),
data = pass2024)
summary(multilevel_fit)
tmp <- coef(multilevel_fit)
tmp[["passer_player_id"]] |> dplyr::slice_head(n = 5)
lmer_alpha <-
data.frame(
lmer = tmp[["passer_player_id"]][,1],
gsis_id = rownames(tmp[["passer_player_id"]]))
alphas <-
alphas |>
dplyr::inner_join(y = lmer_alpha, by = "gsis_id")
View(lmer_alpha)
View(alphas)
alphas |>
dplyr::arrange(dplyr::desc(lmer)) |>
dplyr::slice(c(1:5, (dplyr::n()-4):dplyr::n())) |>
dplyr::select(full_name, lmer, n)
alpha0_hat <- fixef(multilevel_fit)["(Intercept)"]
par(mar = c(3,3,2,1), mgp = c(1.8, 0.5, 0))
plot(alphas$n, alphas$ols,
ylim = c(-4.5, 4.5),
xlab = "Number of passes",
ylab = "Avg. EPA per pass",
main = "EPA per pass",
pch = 16, cex = 0.5, col = oi_colors[9])
points(alphas$n, alphas$lmer, pch = 15, col = oi_colors[2], cex = 0.5)
abline(h = alpha0_hat, col = oi_colors[3])
pass2024 <-
pbp2024 |>
dplyr::filter(play_type == "pass" & season_type == "REG") |>
dplyr::filter(!grepl("TWO-POINT CONVERSION ATTEMPT", desc) &
!grepl("sacked", desc)) |>
dplyr::select(epa, passer_player_id,
air_yards,
posteam_type, shotgun, no_huddle, qb_hit,
pass_location,
desc) |>
dplyr::mutate(posteam_type = factor(posteam_type),
pass_location = factor(pass_location))
pass2024 |> dplyr::slice_head(n = 2)
lambda <- c(1, 0.5, 0.3, 0)
1/(1 + exp(-1 * (lambda[1] - lambda[2])))
outer(X = lambda, Y = lambda, FUN = "-")
probs <- 1/(1 + exp(-1 * outer(X = lambda, Y = lambda, FUN = "-")))
diag(probs) <- NA
round(probs, digits = 3)
round(probs[1,2] * probs[1,3] * probs[1,4], digits = 3)
probs[2,1] * probs[2,3] * probs[4,2] +
probs[2,1] * probs[2,4] * probs[3,2] +
probs[1,2] * probs[2,3] * probs[2,4]
combn(x = 1:4, m = 2)
design <-
combn(x = 1:4, m = 2) |>
t() |>
as.data.frame() |>
dplyr::rename(player1 = V1, player2 = V2) |>
dplyr::rowwise() |>
dplyr::mutate(prob = probs[player1, player2]) |>
dplyr::ungroup()
design
set.seed(479)
outcomes <- rbinom(n = 6, size = 1, prob = design$prob)
outcomes
tmp_df <-
design |>
dplyr::select(player1, player2) |>
dplyr::mutate(
outcome = outcomes,
winner = ifelse(outcome == 1, player1, player2),
player1 = factor(player1, levels = 1:4),
player2 = factor(player2, levels = 1:4),
winner = factor(winner, levels = 1:4))
wins <-
tmp_df |>
dplyr::group_by(winner) |>
dplyr::summarise(Wins = dplyr::n()) |>
dplyr::rename(Team = winner) |>
tidyr::complete(Team, fill = list(Wins = 0))
n_sims <- 5000
simulated_wins <- matrix(data = NA, nrow = n_sims, ncol = 4)
for(r in 1:n_sims){
set.seed(479+r)
outcomes <- rbinom(n = 6, size = 1, prob = design$prob)
wins <-
design |>
dplyr::select(player1, player2) |>
dplyr::mutate(
outcome = outcomes,
winner = ifelse(outcome == 1, player1, player2),
winner = factor(winner, levels = unique(c(design$player1, design$player2)))) |>
dplyr::group_by(winner) |>
dplyr::summarise(Wins = dplyr::n()) |>
dplyr::rename(Team = winner) |>
tidyr::complete(Team, fill = list(Wins = 0))
simulated_wins[r,] <- wins |> dplyr::pull(Wins)
}
table(simulated_wins[,1])
library(cfbfastR)
library(ggplot2)
teams = c("Ohio State", "Indiana", "Texas A&M", "Alabama", "Georgia", "Ole Miss", "BYU", "Texas Tech", "Oregon", "Notre Dame", "Virginia", "Memphis")
fpi <- cfbd_ratings_fpi(year = 2025) |> dplyr::transmute(team, fpi)
Sys.setenv(CFBD_API_KEY = "t5dEoKg3WncPeQCaPKHv5ik8YdFcMyD07Ya0yx1IzoLsuMI4YVi3Zg7UEVsNtulO")
plot_df <- percent_results |>
as.data.frame() |>
tibble::rownames_to_column("Round") |>
tidyr::pivot_longer(-Round, names_to = "Team", values_to = "Percent")
library(cfbfastR)
library(ggplot2)
teams = c("Ohio State", "Indiana", "Texas A&M", "Alabama", "Georgia", "Ole Miss", "BYU", "Texas Tech", "Oregon", "Notre Dame", "Virginia", "Memphis")
fpi <- cfbd_ratings_fpi(year = 2025) |> dplyr::transmute(team, fpi)
sp  <- cfbd_ratings_sp(year = 2025)  |> dplyr::transmute(team, sp = rating) |> dplyr::filter(team != "nationalAverages")
elo <- cfbd_ratings_elo(year = 2025) |> dplyr::transmute(team, elo)
srs <- cfbd_ratings_srs(year = 2025) |> dplyr::transmute(team, srs = rating)
z_scores <- fpi |> dplyr::full_join(sp,  by = "team") |> dplyr::full_join(elo, by = "team") |> dplyr::full_join(srs, by = "team") |> tidyr::drop_na() |>
dplyr::mutate(
z_fpi = as.numeric(scale(fpi)),
z_sp  = as.numeric(scale(sp)),
z_elo = as.numeric(scale(elo)),
z_srs = as.numeric(scale(srs)),
composite = (z_fpi + z_sp + z_elo + z_srs)/4
)
ratings_com = c()
for (t in teams) {
rating = (z_scores |> dplyr::filter(team == t))$composite[1]
cat(t, ": ", rating, "\n", sep="")
ratings_com = c(ratings_com, rating)
}
probs_com <- 1/(1 + exp(-1 * outer(X = ratings_com, Y = ratings_com, FUN = "-")))
diag(probs_com) <- NA
round(probs_com, digits = 3)
design <-
data.frame(home_team = c(5, 6, 7, 8), away_team = c(12, 11, 10, 9)) |>
dplyr::rowwise() |>
dplyr::mutate(prob = probs_com[home_team, away_team]) |>
dplyr::ungroup()
design
n_sims <- 500
simulated_wins_r1 <- matrix(data = NA, nrow = n_sims, ncol = 12)
simulated_wins_r2 <- matrix(data = NA, nrow = n_sims, ncol = 12)
simulated_wins_r3 <- matrix(data = NA, nrow = n_sims, ncol = 12)
simulated_champs <- matrix(data = NA, nrow = n_sims, ncol = 12)
for(r in 1:n_sims){
set.seed(478+r)
outcomes <- rbinom(n = 4, size = 1, prob = design$prob)
round1 <-
design |>
dplyr::select(home_team, away_team) |>
dplyr::mutate(
outcome = outcomes,
winner = ifelse(outcome == 1, home_team, away_team),
winner = factor(winner, levels = 1:12)) |>
dplyr::group_by(winner) |>
dplyr::summarise(Wins = dplyr::n()) |>
dplyr::rename(Team = winner) |>
tidyr::complete(Team, fill = list(Wins = 0))
simulated_wins_r1[r,] = round1 |> dplyr::pull(Wins)
winner_512 = ifelse(round1$Wins[5] == 1, 5, 12)
winner_611 = ifelse(round1$Wins[6] == 1, 6, 11)
winner_710 = ifelse(round1$Wins[7] == 1, 7, 10)
winner_89 = ifelse(round1$Wins[8] == 1, 8, 9)
design2 <-
data.frame(high_seed = c(1, 2, 3, 4), low_seed = c(winner_89, winner_710, winner_611, winner_512)) |>
dplyr::rowwise() |>
dplyr::mutate(prob = probs_com[high_seed, low_seed]) |>
dplyr::ungroup()
design2
outcomes2 <- rbinom(n = 4, size = 1, prob = design2$prob)
round2 <-
design2 |>
dplyr::select(high_seed, low_seed) |>
dplyr::mutate(
outcome = outcomes2,
winner = ifelse(outcome == 1, high_seed, low_seed),
winner = factor(winner, levels = 1:12)) |>
dplyr::group_by(winner) |>
dplyr::summarise(Wins = dplyr::n()) |>
dplyr::rename(Team = winner) |>
tidyr::complete(Team, fill = list(Wins = 0))
simulated_wins_r2[r,] = round2 |> dplyr::pull(Wins)
winner_4512 = if (round2$Wins[4] == 1) {
4
} else if (round2$Wins[5] == 1) {
5
} else {
12
}
winner_3611 = if (round2$Wins[3] == 1) {
3
} else if (round2$Wins[6] == 1) {
6
} else {
11
}
winner_2710 = if (round2$Wins[2] == 1) {
2
} else if (round2$Wins[7] == 1) {
7
} else {
10
}
winner_189 = if (round2$Wins[1] == 1) {
1
} else if (round2$Wins[8] == 1) {
8
} else {
9
}
design3 <-
data.frame(team1 = c(winner_189, winner_2710), team2 = c(winner_4512, winner_3611)) |>
dplyr::rowwise() |>
dplyr::mutate(prob = probs_com[team1, team2]) |>
dplyr::ungroup()
design3
outcomes3 <- rbinom(n = 2, size = 1, prob = design3$prob)
round3 <-
design3 |>
dplyr::select(team1, team2) |>
dplyr::mutate(
outcome = outcomes3,
winner = ifelse(outcome == 1, team1, team2),
winner = factor(winner, levels = 1:12)) |>
dplyr::group_by(winner) |>
dplyr::summarise(Wins = dplyr::n()) |>
dplyr::rename(Team = winner) |>
tidyr::complete(Team, fill = list(Wins = 0))
simulated_wins_r3[r,] = round3 |> dplyr::pull(Wins)
champ_team1 = (round3 |> dplyr::filter(Wins != 0))$Team[1]
champ_team2 = (round3 |> dplyr::filter(Wins != 0))$Team[2]
design4 <-
data.frame(team1 = c(champ_team1), team2 = c(champ_team2)) |>
dplyr::rowwise() |>
dplyr::mutate(prob = probs_com[team1, team2]) |>
dplyr::ungroup()
design4
outcomes4 <- rbinom(n = 1, size = 1, prob = design4$prob)
round4 <-
design4 |>
dplyr::select(team1, team2) |>
dplyr::mutate(
outcome = outcomes4,
winner = ifelse(outcome == 1, team1, team2),
winner = factor(winner, levels = 1:12)) |>
dplyr::group_by(winner) |>
dplyr::summarise(Wins = dplyr::n()) |>
dplyr::rename(Team = winner) |>
tidyr::complete(Team, fill = list(Wins = 0))
simulated_champs[r,] = round4 |> dplyr::pull(Wins)
}
percent_results <- data.frame(matrix(nrow = 4, ncol = 0))
for (i in 1:length(teams)) {
team = teams[i]
wins1 = table(simulated_wins_r1[,i])[2]
percent1 = ifelse(i < 5, 100, round(wins1/n_sims, digits = 4)*100)
wins2 = table(simulated_wins_r2[,i])[2]
percent2 = round(wins2/n_sims, digits = 4)*100
wins3 = table(simulated_wins_r3[,i])[2]
percent3 = round(wins3/n_sims, digits = 4)*100
wins4 = table(simulated_champs[,i])[2]
percent4 = round(wins4/n_sims, digits = 4)*100
percent_results[[team]] <- c(percent1, percent2, percent3, percent4)
}
rownames(percent_results) <- c("Round 1", "Quarterfinal", "Semifinal", "Championship")
print(percent_results)
team_colors <- c(
"Alabama"    = "#9e1b32",
"Indiana"    = "#990000",
"Ohio State" = "#BB0000",
"Texas A&M"  = "#500000",
"Georgia"    = "#BA0C2F",
"Ole Miss"   = "#006BA6",
"Notre Dame" = "#c99700",
"Oregon"     = "#007030",
"Texas Tech" = "#CC0000",
"BYU"        = "#0062B8",
"Virginia"   = "#F84C1E",
"Memphis"    = "#003087"
)
plot_df <- percent_results |>
as.data.frame() |>
tibble::rownames_to_column("Round") |>
tidyr::pivot_longer(-Round, names_to = "Team", values_to = "Percent")
plot_r1 <- plot_df |> dplyr::filter(Round == "Round 1")
plot_r2 <- plot_df |> dplyr::filter(Round == "Quarterfinal")
plot_r3 <- plot_df |> dplyr::filter(Round == "Semifinal")
plot_r4 <- plot_df |> dplyr::filter(Round == "Championship")
round1plot = ggplot2::ggplot(plot_r1, aes(x = reorder(Team, -Percent), y = Percent, fill = Team)) +
geom_col(width = 0.7) +
geom_text(aes(label = sprintf("%.1f%%", Percent)),
vjust = -0.4, size = 3) +
labs(
title = "Round 1 Win Probabilities",
x = "Team",
y = "Win Probability (%)"
) +
scale_fill_manual(values = team_colors) +
theme_minimal(base_size = 14) +
theme(
legend.position = "none",
axis.text.x = element_text(angle = 45, hjust = 1)
)
round2plot = ggplot2::ggplot(plot_r2, aes(x = reorder(Team, -Percent), y = Percent, fill = Team)) +
geom_col(width = 0.7) +
geom_text(aes(label = sprintf("%.1f%%", Percent)),
vjust = -0.4, size = 3) +
labs(
title = "Quarterfinal Win Probabilities",
x = "Team",
y = "Win Probability (%)"
) +
scale_fill_manual(values = team_colors) +
theme_minimal(base_size = 14) +
theme(
legend.position = "none",
axis.text.x = element_text(angle = 45, hjust = 1)
)
round3plot = ggplot2::ggplot(plot_r3, aes(x = reorder(Team, -Percent), y = Percent, fill = Team)) +
geom_col(width = 0.7) +
geom_text(aes(label = sprintf("%.1f%%", Percent)),
vjust = -0.4, size = 3) +
labs(
title = "Semifinal Win Probabilities",
x = "Team",
y = "Win Probability (%)"
) +
scale_fill_manual(values = team_colors) +
theme_minimal(base_size = 14) +
theme(
legend.position = "none",
axis.text.x = element_text(angle = 45, hjust = 1)
)
round4plot = ggplot2::ggplot(plot_r4, aes(x = reorder(Team, -Percent), y = Percent, fill = Team)) +
geom_col(width = 0.7) +
geom_text(aes(label = sprintf("%.1f%%", Percent)),
vjust = -0.4, size = 3) +
labs(
title = "Championship Win Probabilities",
x = "Team",
y = "Win Probability (%)"
) +
scale_fill_manual(values = team_colors) +
theme_minimal(base_size = 14) +
theme(
legend.position = "none",
axis.text.x = element_text(angle = 45, hjust = 1)
)
ggsave("round1_plot.png", plot = round1plot, width = 8, height = 5, dpi = 300)
ggsave("round2_plot.png", plot = round2plot, width = 8, height = 5, dpi = 300)
ggsave("round3_plot.png", plot = round3plot, width = 8, height = 5, dpi = 300)
ggsave("round4_plot.png", plot = round4plot, width = 8, height = 5, dpi = 300)
![Figure 1: 2025 Predictions â€” Bracket Visualization]("predict25.png")
View(z_scores)
# What Pandoc does rmarkdown see?
rmarkdown::find_pandoc()
Sys.which("pandoc")
rmarkdown::find_pandoc()
Sys.which("pandoc")
system("ls -l /usr/local/bin/pandoc")
system("file /usr/local/bin/pandoc")
Sys.unsetenv("RSTUDIO_PANDOC")
Sys.setenv(RSTUDIO_PANDOC = "/Applications/RStudio.app/Contents/Resources/app/quarto/bin/tools")
rmarkdown::find_pandoc(cache = FALSE)
rmarkdown::pandoc_available()
Sys.unsetenv("RSTUDIO_PANDOC")
Sys.setenv(RSTUDIO_PANDOC = "/Applications/RStudio.app/Contents/MacOS/pandoc")
rmarkdown::find_pandoc(cache = FALSE)
rmarkdown::pandoc_available()
pandoc_dir <- "/Applications/RStudio.app/Contents/Resources/app/quarto/bin/tools"
Sys.setenv(RSTUDIO_PANDOC = pandoc_dir)
Sys.setenv(PATH = paste(pandoc_dir, Sys.getenv("PATH"), sep = .Platform$path.sep))
Sys.which("pandoc")
try(system("mv /usr/local/bin/pandoc /usr/local/bin/pandoc.bak", ignore.stderr = TRUE))
Sys.which("pandoc")
Sys.setenv(RSTUDIO_PANDOC = dirname(Sys.which("pandoc")))
Sys.setenv(PATH = paste(Sys.getenv("RSTUDIO_PANDOC"), Sys.getenv("PATH"), sep = .Platform$path.sep))
install.packages("brew")
brew install pandoc
pandoc_dir <- "/usr/local/bin/pandoc"
Sys.setenv(RSTUDIO_PANDOC = pandoc_dir)
Sys.setenv(PATH = paste(pandoc_dir, Sys.getenv("PATH"), sep = .Platform$path.sep))
rmarkdown::find_pandoc()
setwd("~/Downloads/CFB Project/2025 Predictions")
knit_with_parameters("~/Downloads/CFB Project/2025 Predictions/FinalReport.Rmd")
